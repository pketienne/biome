# Parser: Inline Image Parsing

**Status:** In Progress
**Created:** 2026-02-09
**Effort:** Medium
**Impact:** Completes inline element parsing, benefits image-related lint rules

---

## Context

The Biome markdown parser has been incrementally improved. Inline parsing for **code spans, links, emphasis, and italic** is already implemented in `syntax.rs` (lines 350-604). The one missing inline element is **images** (`![alt](url)`). The existing grammar for `MdInlineImage` is wrong — it represents `[![alt](img)](link)` (a linked image wrapped in outer brackets) rather than the standard `![alt](url)` syntax. This needs a grammar fix + parser implementation.

## Step 1: Fix MdInlineImage grammar

**File:** `xtask/codegen/markdown.ungram` (lines 204-210)

Change from:
```ungram
MdInlineImage =
    '['
    '!'
    alt: MdInlineImageAlt
    source: MdInlineImageSource
    ']'
    link: MdInlineImageLink?
```

To:
```ungram
MdInlineImage =
    '!'
    alt: MdInlineImageAlt
    source: MdInlineImageSource
    link: MdInlineImageLink?
```

This removes the outer `[` and `]` tokens, making the grammar match standard `![alt](url)`:
- `!` (BANG token)
- `[alt]` (MdInlineImageAlt = `[` content `]`)
- `(url)` (MdInlineImageSource = `(` content `)`)
- Optional link (always absent for basic images)

Note: `[![alt](url)](link)` is naturally an MdInlineLink whose text contains an MdInlineImage.

## Step 2: Run grammar codegen

```bash
just gen-grammar
```

MdInlineImage changes from 6 slots to 4 slots:
- Old: `l_brack_token`, `excl_token`, `alt`, `source`, `r_brack_token`, `link`
- New: `excl_token`, `alt`, `source`, `link`

## Step 3: Implement image parsing in parser

**File:** `crates/biome_markdown_parser/src/syntax.rs`

### 3a: Add detection function

```rust
fn at_inline_image_start(p: &mut MarkdownParser) -> bool {
    p.cur() == MD_TEXTUAL_LITERAL && p.cur_text() == "!"
}
```

### 3b: Add try_parse_inline_image function

Following the same checkpoint/backtrack pattern as `try_parse_inline_link`.

### 3c: Add image dispatch to parse_inline_list

Insert image check BEFORE link check (since `!` won't match `[`).

## Step 4: Fix any compilation issues

The formatters (`inline_image.rs`, `inline_image_alt.rs`, `inline_image_source.rs`, `inline_image_link.rs`) use text iteration — they don't access specific node slots — so they should compile without changes.

## Verification

```bash
just gen-grammar
cargo build -p biome_markdown_parser -p biome_markdown_formatter -p biome_markdown_analyze
cargo test -p biome_markdown_parser
cargo test -p biome_markdown_formatter
cargo test -p biome_markdown_analyze
cargo test -p biome_cli -- handle_markdown
```

## Files Modified

| File | Change |
|------|--------|
| `xtask/codegen/markdown.ungram` | Remove `[` and `]` from MdInlineImage |
| Generated files (7+) | Auto-regenerated by `just gen-grammar` |
| `crates/biome_markdown_parser/src/syntax.rs` | Add image detection + parsing + dispatch |
| `kb/tasks/07-remaining-work-summary.md` | Update status |
