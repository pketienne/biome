# Unblock Fenced Code Block Formatter: Grammar + Parser + Formatter

**Status:** Done
**Created:** 2026-02-09
**Effort:** Medium
**Impact:** Enables proper fenced code block AST nodes + formatter normalization

---

## Context

The `MdFencedCodeBlock` AST type exists but the parser never creates it — fenced code blocks are parsed as `MdParagraph` nodes. The blocker (discovered in the previous attempt) is that the grammar defines `content: MdTextual` which can only hold a single token, but fenced code block content is multi-token. The lexer change (combining 3+ backticks/tildes into single tokens) is already in place.

This plan fixes the grammar, regenerates code, implements the parser, and adds formatting logic.

## Step 1: Update grammar

**File**: `xtask/codegen/markdown.ungram`

Change lines 110-118 from:
```ungram
MdFencedCodeBlock =
	l_fence: '```'
	code_list: MdCodeNameList
	l_hard_line: MdHardLine
	content: MdTextual
	r_hard_line: MdHardLine
	r_fence: '```'

MdCodeNameList = (MdTextual (',' MdTextual)*)
```

To:
```ungram
MdFencedCodeBlock =
	l_fence: '```'
	code_list: MdCodeNameList
	content: MdInlineItemList
	r_fence: '```'

MdCodeNameList = MdTextual*
```

Changes:
- `content: MdTextual` → `content: MdInlineItemList` — allows multi-token content (list of `AnyMdInline` which includes `MdTextual`)
- Remove `l_hard_line` and `r_hard_line` — newlines are already token trivia, empty hard line nodes add no value
- `MdCodeNameList` from comma-separated list to regular node list — markdown info strings aren't comma-separated
- Slot count: 6 → 4

## Step 2: Run codegen

```bash
just gen-grammar
```

Regenerates `nodes.rs`, `kind.rs`, `syntax_factory.rs`, `node_factory.rs`, `macros.rs` in both `biome_markdown_syntax` and `biome_markdown_factory`.

Expected generated API for `MdFencedCodeBlock`:
- `l_fence_token()` → `SyntaxResult<SyntaxToken>` (slot 0)
- `code_list()` → `MdCodeNameList` (slot 1, now `AstNodeList<MdTextual>`)
- `content()` → `MdInlineItemList` (slot 2, list type)
- `r_fence_token()` → `SyntaxResult<SyntaxToken>` (slot 3)

## Step 3: Update parser

**File**: `crates/biome_markdown_parser/src/syntax.rs`

Implement `at_fenced_code_block` — detect `MD_TEXTUAL_LITERAL` tokens with 3+ same fence chars (leverages existing lexer):
```rust
pub(crate) fn at_fenced_code_block(p: &mut MarkdownParser) -> bool {
    if p.cur() != MD_TEXTUAL_LITERAL { return false; }
    let text = p.cur_text();
    text.len() >= 3 && (text.chars().all(|c| c == '`') || text.chars().all(|c| c == '~'))
}
```

Implement `parse_fenced_code_block` — create proper `MdFencedCodeBlock` nodes:
- Slot 0: `p.bump_remap(TRIPLE_BACKTICK)` for opening fence (both ``` and ~~~ get TRIPLE_BACKTICK kind)
- Slot 1: Wrap each token on opening line in `MdTextual`, collect into `MD_CODE_NAME_LIST`
- Slot 2: Wrap each content token in `MdTextual`, collect into `MD_INLINE_ITEM_LIST`, stop at closing fence
- Slot 3: `p.bump_remap(TRIPLE_BACKTICK)` for closing fence, consume trailing tokens on line

Add `is_closing_fence` helper — checks `has_preceding_line_break()` + token is all same fence chars with `len >= min_count`.

**Import**: Add `TRIPLE_BACKTICK` to the existing kind imports.

## Step 4: Update formatter

**File**: `crates/biome_markdown_formatter/src/md/auxiliary/fenced_code_block.rs`

Replace `format_verbatim_node` passthrough with real formatting (following `thematic_break_block.rs` pattern):
- Get `l_fence_token`, check if tilde, normalize to backticks via `format_replaced` + `text()`
- Format `code_list` and `content` verbatim
- Get `r_fence_token`, normalize similarly
- Only replace when tilde fence detected; backtick fences pass through unchanged

## Step 5: Fix any compilation issues

The codegen may regenerate formatter dispatch stubs that reference old fields (`l_hard_line`, `r_hard_line`). Check and fix compilation errors in:
- Generated formatter files that dispatch to `FormatMdFencedCodeBlock`
- Any code that references the removed hard_line accessors

## Step 6: Update tests and verify

1. **Parser tests**: Run `cargo test -p biome_markdown_parser`. Update snapshots with `cargo insta accept` if AST structure changes affect existing test fixtures.
2. **Formatter tests**: Run `cargo test -p biome_markdown_formatter`.
3. **Analyzer tests** (critical): Run `cargo test -p biome_markdown_analyze` — all 200 tests must pass. The lint rules use `Ast<MdDocument>` + text-based `FenceTracker` scanning. Since the CST is lossless, `document.syntax().text_with_trivia()` returns identical text regardless of tree structure, so rules should work unchanged.

## Files to modify

| File | Change |
|------|--------|
| `xtask/codegen/markdown.ungram` | Simplify MdFencedCodeBlock (4 slots), change MdCodeNameList to node list |
| Generated files (5+) | Auto-regenerated by `just gen-grammar` |
| `crates/biome_markdown_parser/src/syntax.rs` | Implement fenced code block detection + parsing |
| `crates/biome_markdown_formatter/src/md/auxiliary/fenced_code_block.rs` | Normalize tilde → backtick |

## Verification

```bash
just gen-grammar
cargo build -p biome_markdown_parser -p biome_markdown_formatter -p biome_markdown_analyze
cargo test -p biome_markdown_parser
cargo test -p biome_markdown_formatter
cargo test -p biome_markdown_analyze  # all 200 must pass
```
