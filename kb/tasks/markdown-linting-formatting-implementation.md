# Markdown Linting & Formatting Implementation Log

## Overview

Added markdown linting (5 rules) and formatting support to this biome fork. The work spans the parser, analyzer, formatter, codegen, and service integration layers.

## What Was Done

### 1. Service Integration (`biome_service`)

**File: `crates/biome_service/src/file_handlers/markdown.rs`**

- Created full `ExtensionHandler` implementation for markdown
- Registered `.md`/`.mdx` file extensions via `DocumentFileSource`
- Implemented `ServiceLanguage` for `MarkdownLanguage` with format options, analyzer options, linter/formatter/assist enabled checks
- Wired `parse`, `lint`, `code_actions`, `fix_all`, `format` functions into capabilities
- Added `MarkdownFormatterSettings`, `MarkdownLinterSettings`, `MarkdownAssistSettings` structs

### 2. Analyzer Crate (`biome_markdown_analyze`)

**Created the entire crate from scratch.**

Structure:
```
crates/biome_markdown_analyze/
  src/
    lib.rs              -- analyze() entry point, rule registry
    lint/
      mod.rs            -- declares nursery group
      nursery/
        mod.rs          -- declares individual rules
        no_missing_language.rs
        no_invalid_heading_level.rs
        no_duplicate_headings.rs
        no_empty_links.rs
        no_reversed_links.rs
    suppression_action.rs
  Cargo.toml
```

#### Lint Rules Implemented

| Rule | What it catches | Approach |
|------|----------------|----------|
| `noMissingLanguage` (MD040) | Fenced code blocks without language tag | Text-based: queries `MdDocument`, scans lines for ``` fences, tracks open/close state |
| `noInvalidHeadingLevel` (MD001) | Heading level jumps (h1 → h3) | AST-based: traverses `MdHeader` nodes, checks `before().len()` for level |
| `noDuplicateHeadings` (MD024) | Same heading text repeated | AST-based: traverses `MdHeader` nodes, tracks seen text in HashMap |
| `noEmptyLinks` (MD042) | `[text]()` with empty href | Text-based: queries `MdDocument`, scans paragraphs for `[text]()` pattern |
| `noReversedLinks` (MD011) | `(text)[url]` instead of `[text](url)` | Text-based: queries `MdDocument`, scans paragraphs for reversed pattern |

**Why text-based for some rules:** The parser doesn't produce `MdFencedCodeBlock` or `MdInlineLink` AST nodes (the lexer emits everything as `MD_TEXTUAL_LITERAL` and the factory requires specific token types like `TRIPLE_BACKTICK`). Rules that need these constructs use text matching on `MdDocument` or `MdParagraph` text instead.

### 3. Parser Fixes (`biome_markdown_parser`)

**File: `crates/biome_markdown_parser/src/syntax.rs`**

Critical discovery: `NEWLINE`, `WHITESPACE`, and `TAB` are ALL trivia in the markdown lexer (defined in `biome_markdown_syntax/src/lib.rs` `is_trivia()`). The parser never sees them as tokens — `p.at(NEWLINE)` is always false.

**Rewrote the parser to use `p.has_preceding_line_break()` for line boundary detection:**

- `parse_paragraph`: consume first token, then continue while `!has_preceding_line_break()`
- `parse_header`: ATX heading detection (`#` tokens), first hash handled specially (it has preceding line break), uses `bump_remap(HASH)` to change `MD_TEXTUAL_LITERAL` to `HASH`
- `parse_fenced_code_block`: fence detection (``` or ~~~), consumed as paragraphs (factory requires `TRIPLE_BACKTICK` tokens we can't produce)
- `is_closing_fence`: uses checkpoint/rewind to peek ahead
- `at_header`: checks `cur_text() == "#"`
- `at_fenced_code_block`: checks `cur_text() == "`"` or `"~"`

### 4. Formatter Crate (`biome_markdown_formatter`)

**Created the entire crate from scratch.**

Structure:
```
crates/biome_markdown_formatter/
  src/
    lib.rs          -- entry point, MarkdownFormatLanguage, format_node()
    context.rs      -- MarkdownFormatOptions, MarkdownFormatContext
    comments.rs     -- MarkdownCommentStyle, comment handling
    cst.rs          -- FormatMarkdownSyntaxNode
    prelude.rs      -- common imports
    verbatim.rs     -- verbatim/bogus/suppressed node formatting
    trivia.rs       -- token formatting utilities
    separated.rs    -- separated list formatting
    generated.rs    -- AUTO-GENERATED by codegen
    md/             -- AUTO-GENERATED formatter files per AST node
      auxiliary/    -- ~25 node formatters (document, header, paragraph, etc.)
      any/          -- union type formatters (AnyMdBlock, AnyMdInline)
      bogus/        -- bogus node formatter
      lists/        -- list formatters (block_list, hash_list, inline_item_list, etc.)
    js/             -- misplaced union types (codegen bug with prefix detection)
      any/
        block.rs    -- FormatAnyCodeBlock, FormatAnyContainerBlock, FormatAnyLeafBlock
  Cargo.toml
```

**Current behavior:** All nodes use `format_verbatim_node` (preserves source as-is). This is the correct baseline — individual formatters in `md/auxiliary/` can be customized to normalize formatting.

### 5. Codegen Integration

Three separate codegen systems needed updates:

#### a. Analyzer codegen (`xtask/codegen/src/generate_analyzer.rs`)
- Added `generate_markdown_analyzer()` function
- Added `update_markdown_registry_builder()` function

#### b. Configuration codegen (`xtask/codegen/src/generate_configuration.rs`)
- Added `use biome_markdown_syntax::MarkdownLanguage`
- Added `RegistryVisitor<MarkdownLanguage>` impls for `LintRulesVisitor` and `AssistActionsVisitor`
- Added `biome_markdown_analyze::visit_registry()` calls in two locations

#### c. Configuration proc macro (`crates/biome_configuration_macros/`)
- Added `biome_markdown_analyze` and `biome_markdown_syntax` dependencies
- Added `RegistryVisitor<MarkdownLanguage>` impls in `src/visitors.rs`
- Added `biome_markdown_analyze::visit_registry()` calls in `src/lib.rs` (`collect_lint_rules()` and `collect_assist_rules()`)

#### d. Formatter codegen (`xtask/codegen/src/formatter.rs`)
- Added `Md` variant to `NodeDialect` enum
- Added to `all()`, `as_str()`, `from_str()`
- Changed `"DemoFormatter"` → `"MarkdownFormatter"` and `"DemoFormatterContext"` → `"MarkdownFormatContext"`

#### e. Rule move codegen (`xtask/codegen/src/move_rule.rs`)
- Added `"crates/biome_markdown_analyze"` to `KNOWN_PATHS`

### 6. Other Changes

- Added `filetime` build dependency to `biome_markdown_analyze/Cargo.toml` (needed by codegen-generated `build.rs`)
- Added `biome_markdown_formatter` to workspace `Cargo.toml`
- Added `biome_markdown_formatter` dependency to `biome_service/Cargo.toml`

## Key Architectural Insights

### Trivia Model
NEWLINE, WHITESPACE, TAB are trivia — invisible to the parser. Use `p.has_preceding_line_break()` for line boundaries. First token on a line has `has_preceding_line_break() == true` but still needs to be consumed.

### `bump_remap(kind)`
Consumes current token but changes its kind. Used to turn `MD_TEXTUAL_LITERAL` tokens with text `#` into `HASH` tokens for heading AST nodes.

### SyntaxFactory Constraints
Each node type has a factory that checks exact slot kinds. `MD_HEADER` expects `[MdHashList, optional MdParagraph, MdHashList]` — achievable with `bump_remap`. `MD_FENCED_CODE_BLOCK` expects `TRIPLE_BACKTICK` tokens — not achievable from the current lexer, so fenced code blocks are consumed as paragraphs.

### Three Registration Points for Rules
A new language analyzer must be registered in THREE places:
1. `xtask/codegen/src/generate_configuration.rs` — for `rules.rs` codegen
2. `crates/biome_configuration_macros/src/lib.rs` + `visitors.rs` — for Nursery struct proc macro
3. `xtask/codegen/src/generate_analyzer.rs` — for `registry.rs` codegen

Missing any one causes rules to silently not appear or be rejected as "unknown key" in biome.json.

## Verification

```bash
# Lint all 5 rules fire correctly
biome lint test.md

# Format works (verbatim pass-through, trailing newline normalization)
biome format test.md

# Both together
biome check test.md

# Format in place
biome format --write test.md
```

## Next Steps

- Customize individual node formatters for heading normalization, list marker style, etc.
- Add more lint rules from the prioritized list (noInvalidLinkFragments, noMissingAltText, etc.)
- Parser improvements as needed for new rules
- Add code actions (auto-fixes) for existing rules
